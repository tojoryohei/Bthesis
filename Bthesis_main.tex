\documentclass[dvipdfmx,a4j,12pt]{jreport}
%\documentclass{jreport}
\usepackage[dvipdfmx]{graphicx}
\usepackage{booktabs}
\usepackage{amsmath,amssymb}
\usepackage{here}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{hhline}
\usepackage{makecell}
\usepackage{tabularx}
\usepackage[hang,small,bf]{caption}
\usepackage[subrefformat=parens]{subcaption}
\usepackage{url}
\usepackage{tikz}
\captionsetup{compatibility=false}
\usetikzlibrary{arrows.meta, positioning, calc}

\def\syaji{ \chapter*{謝辞} \addcontentsline{toc}{chapter}{謝辞}}
\renewcommand{\bibname}{参考文献}
\setlength{\textheight}{\paperheight}
\setlength{\topmargin}{4.6mm}
\addtolength{\topmargin}{-\headheight}
\addtolength{\topmargin}{-\headsep}
\addtolength{\topmargin}{-\headheight}
\addtolength{\textheight}{-60mm}

\setlength{\textwidth}{\paperwidth}
\setlength{\oddsidemargin}{-0.4mm}
\setlength{\evensidemargin}{-0.4mm}
\addtolength{\textwidth}{-50mm}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%
% 表紙
%%%%%%%%%%%%%%%%%%%%%
\thispagestyle{empty}
\begin{center}
  \begin{Large}
    \vspace*{0.7cm}
    {\large 卒業研究論文}\\
    \vspace*{2.5cm}
    {\LARGE\bf JR最安分割乗車券探索システムの開発}\\
    \vspace*{7.5cm}
    東條 涼平\\
    学籍番号\hspace*{1zw}22D8102015D\\
    \vspace*{2.5cm}
    中央大学理工学部情報工学科\hspace*{1zw} アルゴリズム理論基礎研究室\\
    \vspace*{3.0cm}
    2026年3月\\
  \end{Large}
\end{center}


%%%%%%%%%%%%%%%%%%%%%
% 概要
%%%%%%%%%%%%%%%%%%%%%
\newpage
\renewcommand{\baselinestretch}{1.25} \selectfont
\pagenumbering{roman}


\begin{center} {\large \bf{概　要}} \end{center}

JR線を利用する際，安く移動をしようとするとき，通しで購入する乗車券の運賃よりも乗車区間を途中で区切って複数枚の乗車券を購入するほうが安い場合がある．
この区間を分けて購入した乗車券を分割乗車券という．
最安の分割乗車券の経路が最短経路でない場合もあるから，従来の手法では，任意の駅間において分割乗車券を考慮したときに最安解を出すためには，最適解のルートとして考えられる経路の全てで分割乗車券の運賃を比較する必要があった．
そこで，Dijkstra's Algorithm\cite{dijkstra}とYen's Algorithm\cite{yen}を使って最安となりうる経路の候補を出し，それぞれに対して分割経路を計算をして，それらの結果をもとに最安解を出力することにより，経路を指定せずに発駅と着駅の入力のみで最適解を出すプログラムを作成した．

\vspace{1zw} \noindent
{\bf キーワード: }分割乗車券，経路探索，JR運賃計算，グラフ理論

%%%%%%%%%%%%%%%%%%%%%
% 目次
%%%%%%%%%%%%%%%%%%%%%
\tableofcontents

\newpage
\pagenumbering{arabic}

%%%%%%%%%%%%%%%%%%%%%
% 1章
%%%%%%%%%%%%%%%%%%%%%
\chapter{序論} \label{chapter:intro}

JRでは営業キロを一定の幅に区切って運賃を設定しているため，乗車券の区間を分割して購入したほうが安くなる場合がある．
区間を分けて乗車券を購入することを分割乗車券といい，2000年以前からインターネット上で知られていた．
発駅と着駅のほかに経路を指定した場合であれば，最安解を出力する分割乗車券プログラム\cite{oba}が既に存在する．
多くの場合では，発駅から着駅までを結ぶ最短経路上に分割駅が存在するが，都心のような狭い範囲で路線が密集している場合など，最短経路上に分割駅が無い場合もある．
そのため，旅客が最安解である経路を特定することは困難である．

分割乗車券プログラムをWebアプリとして公開しているサイト\cite{oba}では，発駅と着駅の他に経路を指定する必要があり，その経路上で最安分割乗車券を探索する．
また，分割乗車券に特化した先行研究として，平田ら\cite{hirata}によるスマートフォンを利用した乗車券分割アプリの事例がある．
しかし，平田らの手法では最短経路上で分割回数が1回に限定されているという制約があり，探索エリアも関西の一部エリアのみである．
既存の乗車券分割プログラム\cite{oba}においても，探索範囲は全国に及ぶが，利用者が経路を事前に指定する必要があるため，迂回路を含んだ真に最安となる経路を利用者自身が見つけなければならず，事実上不可能である．
したがって，経路指定を必要とせず，かつ分割回数やエリアに制限のない探索手法が求められている．

本研究の目的は，発駅と着駅のみを入力とし，分割乗車券を含む最安経路を自動的に導出するシステムを構築することである．
本研究の主な貢献は以下の3点である．
\begin{enumerate}
    \item \textbf{経路指定不要の探索:}\\
        Dijkstra's Algorithm\cite{dijkstra}とYen's Algorithm\cite{yen}を組み合わせることで，利用者が経路を指定することなく，分割乗車券によって安価となる迂回経路も含めた探索を可能にした．
    \item \textbf{複雑な運賃規則の網羅:}\\
        「経路特定区間」や「遠距離逓減に伴う逆転現象」など，単純なグラフ探索では扱えないJR特有の運賃規則をアルゴリズムに組み込み，厳密解を特定できるようにした．
    \item \textbf{厳密解探索における計算コストと課題の明確化:}\\
        探索打ち切り条件の最適化や，必要な区間運賃のみを計算する高速化手法を実装し，その挙動を長距離区間において検証した．
        評価の結果，現状のアルゴリズムではWebサービス水準の即応性確保が困難となる計算量のリスクを定量的に示し，複雑な運賃制度を厳密に考慮した探索におけるボトルネックを特定した．
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%
% 2章
%%%%%%%%%%%%%%%%%%%%%
\chapter{JR運賃制度と問題の定義} \label{chapter:fare_system}
この章では，JRの複雑な運賃計算の手順と，本研究が扱う「逆転現象」などの特例について整理する．

\section{片道乗車券}
まずは，本研究で扱う片道乗車券の定義について解説する．
片道乗車券は，実際に乗車する経路及び発着の順序によって定まる．
片道乗車券における経路は重複してはならず，環状線を超える経路であってはならない．
ここで，環状線を超える経路とは，発駅から一駅ずつ経路を進めて行った場合に閉路ができ，その先の経路を伸ばしたような経路をいう．
つまり，発売可能な経路と不可能な経路の形状パターンは図\ref{fig:ticket_shapes}となる．

\begin{figure}[htbp]
    \centering
    \begin{tikzpicture}[
        station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white},
        path/.style={->, >={Stealth[length=3mm]}, ultra thick, draw=black!70!black},
        label_text/.style={font=\small\bfseries}
    ]

    % --- 上段タイトル: 発売可能 ---
    % 図の中央付近(x=0.5)の上部(y=3.0)に配置
    \node[font=\large\bfseries] at (-4.0, 3.1) {発売可能な経路};

    % 1. 直線 (Straight)
    \begin{scope}[shift={(-4, 0.3)}]
        \node[station, label=below:発] (A) at (0,0) {A};
        \node[station] (B) at (1.5,0) {B};
        \node[station, label=below:着] (C) at (3,0) {C};
        
        \draw[path] (A) -- (B);
        \draw[path] (B) -- (C);
        
        \node[label_text, above=1.2cm of A] {直線}; 
    \end{scope}

    % 2. 環状線 (Loop) - Oの字
    \begin{scope}[shift={(1.4, 0)}]
        \node[station, label=below:発/着] (A) at (0,-0.5) {A};
        \node[station] (B) at (1.5,-0.5) {B};
        \node[station] (C) at (1.5,1) {C};
        \node[station] (D) at (0,1) {D};
        
        \draw[path] (A) -- (B);
        \draw[path] (B) -- (C);
        \draw[path] (C) -- (D);
        \draw[path] (D) -- (A);

        \node[label_text, above=0.5cm of D] {環状線};
    \end{scope}

    % 3. 6の字 (Lasso) - OK
    \begin{scope}[shift={(5, 0)}]
        \node[station, label=below:発] (A) at (0,-0.5) {A};
        \node[station, label=below:着] (B) at (1.5,-0.5) {B}; 
        \node[station] (C) at (3,-0.5) {C};
        \node[station] (D) at (2.25,1) {D};
        
        \draw[path] (A) -- (B);
        \draw[path] (B) -- (C);
        \draw[path] (C) -- (D);
        \draw[path] (D) -- (B);
        
        \node[label_text, above=2.0cm of A] {6の字}; 
    \end{scope}


    % --- 下段タイトル: 発売不可能 ---
    % 上段と下段の間(y=-3.5)に配置
    \node[font=\large\bfseries] at (-3.6, -2.5) {発売不可能な経路};

    % 4. 折り返し - NG
    \begin{scope}[shift={(-3.5, -5.3)}]
        \node[station, label=below:発/着] (A) at (0,0) {A};
        \node[station] (B) at (2,0) {B};
        
        % B-C間を「行き」と「帰り」の2本のカーブ矢印
        \draw[path] (A) to[bend left=10] (B);
        \draw[path] (B) to[bend left=10] (A);
        
        \node[label_text, above=1.3cm of A] {折り返し};
    \end{scope}

    % 5. T字 (Branch) - NG
    \begin{scope}[shift={(0.3, -6.0)}]
        \node[station, label=below:発] (A) at (0,0) {A};
        \node[station] (B) at (1.5,0) {B};
        \node[station] (C) at (1.5,1.5) {C};
        \node[station, label=below:着] (D) at (3,0) {D};
        
        \draw[path] (A) -- (B);
        
        % B-C間を「行き」と「帰り」の2本のカーブ矢印
        \draw[path] (B) to[bend left=20] (C);
        \draw[path] (C) to[bend left=20] (B);
        
        \draw[path] (B) -- (D);
        
        \node[label_text, above=2.0cm of A] {T字};
    \end{scope}

    % 6. 9の字 (9-shape) - NG
    \begin{scope}[shift={(6.5, -6.0)}]
        \node[station, label=below:発] (A) at (0,0) {A};
        \node[station] (B) at (1.5,0) {B};
        \node[station] (C) at (0.75,1.3) {C};
        \node[station, label=below:着] (D) at (-1.5,0) {D};
        
        \draw[path] (A) -- (B);
        \draw[path] (B) -- (C);
        \draw[path] (C) -- (A);
        \draw[path] (A) -- (D);
        
        \node[label_text, above=2.0cm of D] {9の字};
    \end{scope}

    \end{tikzpicture}
    \caption{片道乗車券として発売可能な経路と不可能な経路の形状パターン}
    \label{fig:ticket_shapes}
\end{figure}

\section{JRの運賃計算}
6つの旅客鉄道会社から構成される集合をJRと呼ぶこととし，これ以降はそれぞれの会社に対して通称を使う．
表\ref{tab:companies}に各社の通称を示す．

\begin{table}[H]
\centering
\caption{旅客鉄道会社一覧}
\label{tab:companies}
\begin{tabular}{|c|c|} \hline
会社名 & 通称 \\ \hline
北海道旅客鉄道 & JR北海道 \\ \hline
東日本旅客鉄道 & JR東日本 \\ \hline
東海旅客鉄道 & JR東海 \\ \hline
西日本旅客鉄道 & JR西日本 \\ \hline
四国旅客鉄道 & JR四国 \\ \hline
九州旅客鉄道 & JR九州 \\ \hline
\end{tabular}
\end{table}

また，JR東日本・JR東海・JR西日本をまとめて本州3社と呼ぶ．各旅客鉄道会社に旅客営業規則が定められているが，それぞれに内容の差異は無い．
この研究では，JR東日本の旅客営業規則\cite{ryokaku}を参照する．

次に，運賃計算をする手順を以下に示す．
まず，JRの路線は「幹線」と「地方交通線」のいずれかに分類されており，各駅間には0.1km単位で営業キロが設定されている．
運賃は，乗車区間の営業キロの合計に基づき，対応する距離区分（キロ地帯）や賃率を適用して算出される．
本州3社の幹線内相互発着の場合における大人片道普通旅客運賃の計算手順は旅客営業規則 第77条に定められている．
同様にして，本州3社の地方交通線内相互発着の場合における大人片道普通旅客運賃は旅客営業規則 第77条の5に定められている．
よって，本州3社の幹線は営業キロが240.0kmまで，本州3社の地方交通線は営業キロが200.0kmまでの運賃表は表\ref{tab:fare_comparison}の通りとなる．

\begin{table}[htbp]
  \caption{本州3社の幹線と地方交通線における運賃の比較}
  \label{tab:fare_comparison}
  \centering
  \begin{minipage}[t]{0.48\textwidth}
    \centering
    \caption*{本州3社の幹線の運賃表}
    \begin{tabular}{cr} \toprule
      営業キロ (km) & 運賃 (円) \\ \midrule
      $\ \ \ \ \ \ \sim \ \ 3.0$   & 150 \\
      $\ \ 3.1 \sim \ \ 6.0$   & 190 \\
      $\ \ 6.1 \sim \ 10.0$  & 200 \\
      $\ 10.1 \sim \ 15.0$ & 240 \\
      $\ 15.1 \sim \ 20.0$ & 330 \\
      $\ 20.1 \sim \ 25.0$ & 420 \\
      $\ 25.1 \sim \ 30.0$ & 510 \\
      $\ 30.1 \sim \ 35.0$ & 590 \\
      $\ 35.1 \sim \ 40.0$ & 680 \\
      $\ 40.1 \sim \ 45.0$ & 770 \\
      $\ 45.1 \sim \ 50.0$ & 860 \\
      $\ 50.1 \sim \ 60.0$ & 990 \\
      $\ 60.1 \sim \ 70.0$ & 1,170 \\
      $\ 70.1 \sim \ 80.0$ & 1,340 \\
      $\ 80.1 \sim \ 90.0$ & 1,520 \\
      $\ 90.1 \sim 100.0$ & 1,690 \\
      $100.1 \sim 120.0$ & 1,980 \\
      $120.1 \sim 140.0$ & 2,310 \\
      $140.1 \sim 160.0$ & 2,640 \\
      $160.1 \sim 180.0$ & 3,080 \\
      $180.1 \sim 200.0$ & 3,410 \\
      $200.1 \sim 220.0$ & 3,740 \\
      $220.1 \sim 240.0$ & 4,070 \\ \bottomrule
    \end{tabular}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.48\textwidth}
    \centering
    \caption*{本州3社の地方交通線の運賃表}
    \begin{tabular}{cr} \toprule
      営業キロ (km) & 運賃 (円) \\ \midrule
      $\ \ \ \ \ \ \sim \ \ 3.0$   & 150 \\
      $\ \ 3.1 \sim \ \ 6.0$   & 190 \\
      $\ \ 6.1 \sim \ 10.0$  & 210 \\
      $\ 10.1 \sim \ 15.0$ & 240 \\
      $\ 15.1 \sim \ 20.0$ & 330 \\
      $\ 20.1 \sim \ 23.0$ & 420 \\
      $\ 23.1 \sim \ 28.0$ & 510 \\
      $\ 28.1 \sim \ 32.0$ & 590 \\
      $\ 32.1 \sim \ 37.0$ & 680 \\
      $\ 37.1 \sim \ 41.0$ & 770 \\
      $\ 41.1 \sim \ 46.0$ & 860 \\
      $\ 46.1 \sim \ 55.0$ & 990 \\
      $\ 55.1 \sim \ 64.0$ & 1,170 \\
      $\ 64.1 \sim \ 73.0$ & 1,340 \\
      $\ 73.1 \sim \ 82.0$ & 1,520 \\
      $\ 82.1 \sim \ 91.0$ & 1,690 \\
      $\ 91.1 \sim 100.0$ & 1,880 \\
      $100.1 \sim 110.0$ & 1,980 \\
      $110.1 \sim 128.0$ & 2,310 \\
      $128.1 \sim 146.0$ & 2,640 \\
      $146.1 \sim 164.0$ & 3,080 \\
      $164.1 \sim 182.0$ & 3,410 \\
      $182.1 \sim 200.0$ & 3,740 \\ \bottomrule
    \end{tabular}
  \end{minipage}
\end{table}

また，100.0kmまでの本州3社の幹線における営業キロと運賃のグラフは，図\ref{fig:fare_graph}のようになり，営業キロとキロ単価（運賃／営業キロ）のグラフは図\ref{fig:unit_price_graph}のようになる．

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.85\linewidth]{Figure_0.png}
    \caption{本州3社の幹線における営業キロと運賃の関係}
    \label{fig:fare_graph}

    \vspace{1cm}

    \includegraphics[width=0.85\linewidth]{Figure_1.png}
    \caption{本州3社の幹線における営業キロとキロ単価（運賃／営業キロ）の関係}
    \label{fig:unit_price_graph}

\end{figure}

また，幹線と地方交通線を連続して乗車する場合は，表\ref{tab:rule14}で示すように，地方交通線の乗車区間に対する営業キロを調整した「運賃計算キロ」が用いられる．
本州3社において，この調整については，地方交通線の乗車区間に対する営業キロに地方交通線の第1地帯の賃率17円80銭/kmを幹線の第1地帯の賃率16円20銭/kmで除した値をかけて小数点第2位で四捨五入したものである．
この規則が制定された当時，比率は1.1であり，多くの路線では営業キロを1.1倍した値が用いられている．
しかし，その値と一致しない区間もあったため，第\ref{chapter:program}章の運賃計算プログラムではJR時刻表\cite{jikoku}の換算キロを参照した．

\begin{table}[H]
    \centering
    \caption{運賃計算キロに関する規定（旅客営業規則 第14の2条より抜粋）}
    \label{tab:rule14}
    \fbox{
        \begin{minipage}{\dimexpr\linewidth-2\fboxsep-2\fboxrule}
            \noindent\textbf{（運賃計算キロ）}\\
            \noindent\textbf{第14条の2}\\
            前条の規定によるほか、幹線と地方交通線を連続して乗車する場合（幹線と地方交通線の中間に当社と通過連絡運輸を行う鉄道・軌道・航路又は自動車線が介在する場合で、これらを通じて連続乗車するときを含む。以下同じ。）の旅客運賃を計算するときは、旅客の乗車する発着区間のうち、地方交通線の乗車区間に対する営業キロを賃率比に応じて換算したもの（以下、北海道旅客鉄道株式会社、東日本旅客鉄道株式会社、東海旅客鉄道株式会社及び西日本旅客鉄道株式会社にあっては「賃率換算キロ」、四国旅客鉄道株式会社及び九州旅客鉄道株式会社にあっては「擬制キロ」という。）と幹線の乗車区間に対する営業キロを合算したもの（以下「運賃計算キロ」という。）による。\\

            \noindent\textbf{2}\\
            前項の賃率換算キロ及び擬制キロは、別に定めるものとし、地方交通線の乗車区間に対する営業キロに、第77条の5に規定する地方交通線の第1地帯賃率を第77条に規定する幹線の第1地帯賃率で除した値を乗じて得たもの（小数点以下1位未満の端数があるときはこれを四捨五入する。）とする。\\
            ただし、北海道旅客鉄道会社線内にあっては、地方交通線の乗車区間に対する営業キロに、第77条の6に規定する地方交通線の第1地帯賃率を第77条の2に規定する幹線の第1地帯賃率で除した値を乗じて得たものとする。\\
        \end{minipage}
    }
\end{table}

これとは別に，私鉄と競合する区間においては，通常の運賃計算で求められる運賃よりも安価な運賃となる特定運賃区間が設けられている．
また，新千歳空港駅，宮崎空港駅，りんくうタウン駅が含まれている経路や児島駅と宇多津駅間の瀬戸大橋を通る経路については通常の運賃計算をした上で加算運賃を加える．
さらに，旅客営業規則第140条に基づき，特定の区間内を相互発着する経路を利用する場合には，運賃に加えて鉄道駅バリアフリー料金の10円が収受される（表\ref{tab:rule140}参照）．
本システムでは，適用対象となる区間において，規定の鉄道駅バリアフリー料金を運賃に加算する処理を実装した．
これにより，出力結果を実際の発売額と一致させている．

\begin{table}[H]
    \centering
    \caption{鉄道駅バリアフリー料金に関する規定（旅客営業規則 第140条より一部抜粋）}
    \label{tab:rule140}
    \fbox{
        \begin{minipage}{\dimexpr\linewidth-2\fboxsep-2\fboxrule}
            \noindent\textbf{（鉄道駅バリアフリー料金）}\\
            \noindent\textbf{第140条}\\
            次の各号に掲げる区間内相互発着となる区間に乗車する場合は、鉄道駅バリアフリー料金を収受する。
            \begin{enumerate}
                \item 第78条第2項第1号に定める東京附近における電車特定区間及び第80条の規定を適用する区間（同条第1項第1号から第4号の区間にかかるものに限る。）
                \item 第78条第2項第2号に定める大阪附近における電車特定区間及び第80条の規定を適用する区間（同条第1項第5号から第14号及び同条第2項の区間にかかるものに限る。）
                \item 東海道本線（新幹線）中豊橋・岐阜羽島間、東海道本線中豊橋・大垣間、武豊線、中央本線中多治見・名古屋間、関西本線中名古屋・四日市間（ただし、対象区間のみを経由して乗車する場合に限る。）
            \end{enumerate}

            \noindent\textbf{2}\\
            前項の規定により収受する鉄道駅バリアフリー料金は、次の各号に定めるとおりとする。
            \begin{enumerate}
                \item 前項第1号に掲げる区間内相互発着となる区間に乗車する場合\\
                イ　大人片道普通旅客運賃とあわせ収受する額\\
                　　片道乗車あたり10円
                \item 前項第2号及び第3号に掲げる区間内相互発着となる区間に乗車する場合\\
                イ　大人片道普通旅客運賃とあわせ収受する額\\
                　　片道乗車あたり10円
            \end{enumerate}
        \end{minipage}
    }
\end{table}

\section{対象外とするもの}
今回の研究では，新幹線を使った経路では乗車券の他に特急券が必要となる上に，複雑な例外処理が必要となるため在来線のみを探索の対象とする．
BRT（バス高速輸送システム）は発売に制限があるため探索の対象外とする．
この研究で扱う片道乗車券の運賃計算経路と運賃は，運賃計算の手順が記載されている旅客営業規則\cite{ryokaku}に則って計算をして，駅の窓口や自動券売機で実際に購入できるものを扱い，ICカード運賃は考慮しない．

\section{逆転現象}
運賃は，発駅から着駅までの経路区間に対する運賃計算キロで計算される．
しかし，本研究の主目的である「移動コストの最小化」を達成するためには，単に発着駅間の経路に基づいて運賃を計算するだけでは不十分である．
運賃は，乗車経路の営業キロあるいは運賃計算キロに対して単調非減少であるが，川浦\cite{trrc}が指摘するように，特定の条件下では経路を外方へ延伸することで運賃経路の営業キロあるいは運賃計算キロが短くなり運賃が安くなる「逆転現象」が発生するためである．
この逆転現象が起こった場合，その乗車券は入力された乗車区間のみを使い，乗車しない区間においては権利放棄をして，運賃は乗車経路に対して単調非減少となるようにした．
このとき，券面表示の発駅以外から乗車することを内方乗車，券面表示の着駅以外で下車することを前途放棄と呼ぶ．
本システムでは，以下の事例に代表される逆転現象の特例処理について考慮した実装をし，真の最安運賃を導出できるようにした．
以下で扱う旅客営業規則は付録Aを参照されたい．

\subsection{経路特定区間に関する運賃の逆転現象}\label{subsection:69}
付録Aに示した旅客営業規則 第69条で定められている経路特定区間を乗り通す場合は，いずれの経路を利用した場合でも○印の経路で運賃計算が行われる．
このとき，○印のない経路の途中駅からあるいは途中駅までの運賃よりも，経路を外方の分岐駅まで伸ばすことにより，旅客営業規則 第69条を適用させて，運賃経路を○印経由とした方が安い場合がある．

図\ref{fig:reverse_route_specific}に，経路特定区間における逆転現象の例として函館駅から東森駅までを最安で行く場合を示す．
函館駅の運賃表には東森駅までは1,590円と書かれているが，これは鹿部駅を経由した場合の運賃である．
函館駅から大沼公園駅を経由した後，森駅で列車を乗り換えて東森駅まで行く場合の運賃は1,380円である．
しかし，函館駅から鹿部駅を経由して森駅までの経路を運賃計算すると，旅客営業規則 第69条 第1号が適用される．
したがって，運賃計算経路は大沼公園駅を経由する経路へと補正が行われるため，1,210円で東森駅まで行くことができる．
このとき，不乗区間の東森駅と森駅間については前途放棄を行う．

\begin{figure}[H]
    \centering
    \begin{tikzpicture}[
        station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white, font=\small},
        path_line/.style={-, ultra thick, draw=black!70},
        path_calc/.style={-, ultra thick, draw=black!70},
        path_ride/.style={-, ultra thick, draw=black!70},
        fare_arrow/.style={->, >={Stealth[length=3mm]}, very thick},
        label_text/.style={font=\footnotesize\bfseries}
    ]
    
    \node[station, label=above:函館] (Hakodate) at (0,0) {};
    \node[station, label=above:仁山] (Niyama) at (4.5,0) {};
    \node[station, label=above:大沼] (Onuma) at (6,0) {};
    
    \node[station, label=above:大沼公園] (OnumaKoen) at (8, 0) {};
    \node[station, label=above:森] (Mori) at (13,0) {};
    \node[station, label=above:石倉] (Ishikura) at (14.5,0) {};
    
    \node[station, label=left:鹿部] (Shikabe) at (6.5, -1.5) {};
    \node[station, label=right:東森] (HigashiMori) at (12.5, -1.5) {};
    
    \draw[path_line] (Hakodate) -- (Niyama) -- (Onuma) -- (OnumaKoen) -- (Mori) -- (Ishikura);
    
    \draw[path_ride] (Onuma) to[bend right=15] (Shikabe);
    \draw[path_ride] (Shikabe) to[bend right=25] (HigashiMori);
    \draw[path_ride] (HigashiMori) to[bend right=15] (Mori);
    
    \draw[fare_arrow] (0,1.5) -- node[above, align=center] {函館→森(大沼公園経由)：1,210円（49.5km）} (13,1.5);
    \draw[fare_arrow] (0,-2.8) -- node[below, align=center] {函館→東森(鹿部経由)：1,590円（60.5km）} (12.5,-2.8);
        
    \end{tikzpicture}
    \caption{函館本線（経路特定区間）における運賃の逆転現象}
    \label{fig:reverse_route_specific}
\end{figure}

\subsection{特定都区市内制度の制度設計に起因する運賃の逆転現象}\label{subsection:86}
付録Aに示した旅客営業規則 第86条及び第87条が適用されないような特定都区市内あるいは東京山手線内を発着駅とする経路のうち，旅客営業規則 第86条 及び 第87条 を適用するために，もう一方の駅を外方に伸ばすことで，中心駅からの営業キロが閾値を超えるようにして，運賃を安くすることができる場合がある．

図\ref{fig:reverse_city_zone}に，特定都区市内制度における逆転現象の例として甲南山手駅から丹治部駅までを最安経路で行く場合を示す．
発着駅が特定都区市内にあり，もう一方の駅までの営業キロが200.0km以下の場合は，発着駅間の営業キロまたは運賃計算キロで計算される．
以下では，姫路駅以遠の姫新線が地方交通線のため運賃計算キロを用いる．
しかし，着駅を外方の岩山駅へ延伸して営業キロ200.0kmを超えさせると，発駅は都区市内中心駅の神戸駅からの計算となる．
このとき，神戸駅が甲南山手駅よりも着駅寄りにあり，計算キロが短縮され運賃が安くなる現象が発生する．
よって，甲南山手駅から丹治部駅までの最安運賃は，神戸市内→岩山の運賃である3,740円であり，丹治部駅から岩山駅までは乗車せず前途放棄する．

\begin{figure}[H]
    \centering
    \begin{tikzpicture}[
        station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white},
        zone/.style={draw=gray, dashed, rounded corners, fill=gray!10},
        path_line/.style={-, thick, draw=black},
        path_arrow/.style={->, >={Stealth[length=3mm]}, very thick},
    ]
    
    % 特定都区市内ゾーン
    \filldraw[zone] (-1,-1) rectangle (3,2.5);
    \node at (1, 2) {\bf 神戸市内};
    
    % 駅の配置
    \node[station, label=below:甲南山手] (A) at (0,0) {};
    \node[station, label=below:神戸, fill=black!20] (C) at (2,0) {};
    \node[station, label=below:姫路] (H) at (6,0) {};
    \node[station, label=below:丹治部] (T) at (10,0) {};
    \node[station, label=below:岩山] (E) at (12,0) {};
    
    \node at (4, 0.3) {\small 山陽本線};
    \node at (9, 0.3) {\small 姫新線};
    % 経路
    \draw[path_line] (A) -- (C) -- (H) -- (T) -- (E);
    
    % 距離の比較
    \draw[path_arrow] (0, 1) -- node[above] {　　4,070円（運賃計算キロ：226.8km）} (10, 1);
    \draw[path_arrow] (2, -1.2) -- node[below] {3,740円（運賃計算キロ：219.6km）　　} (12, -1.2);
    
    % 閾値ライン
    \draw[dashed] (11, -0.4) -- (11, 1.7) node[above] {神戸駅からの営業キロ200.0km境界};
    
    \end{tikzpicture}
    \caption{特定都区市内制度適用のために延伸する場合の逆転現象}
    \label{fig:reverse_city_zone}
\end{figure}

\section{分割乗車券と分割運賃}
発駅から着駅までの経路が与えられたとき，乗車区間の途中駅で片道乗車券を区切って購入し，複数枚の片道乗車券を組み合わせてその経路を乗車することのできる片道乗車券の集合を「分割乗車券」と定義する．
分割を行わない1枚の乗車券も，分割乗車券として考える．
発駅と着駅の間に $n$ 個の途中駅が存在する経路を考えると，各途中駅において「分割する」か「分割しない」かの2通りの選択肢が存在するため，その経路における分割乗車券の総数は $2^n$ 通りとなる．
また，分割乗車券を構成する各片道乗車券の運賃の総和を「分割運賃」と定義する．

\section{分割乗車券の合計運賃が安くなりうる理由}
oba\cite{oba}によると，分割運賃が片道運賃よりも安くなりうる主な要因として，以下の5つのケースが挙げられている．
\begin{enumerate}
    \item \textbf{キロ単価の非単調性:}\\
        キロ単価の非単調性により，分割した方が安価となる場合がある．
        島田駅と静岡駅までの東海道線の経路と分割例を図\ref{fig:bunkatsu1}に示す．
        本州3社の幹線での25.1〜30.0kmの運賃は510円であるが，その半分の10.1〜15.0kmの運賃は240円であり，分割しない場合よりも30円安くなる．

        \begin{figure}[htbp]
            \centering
            \begin{tikzpicture}[
                station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white, font=\small},
                path_line/.style={-, ultra thick, draw=black!70},
                path_calc/.style={-, ultra thick, draw=black!70},
                path_ride/.style={-, ultra thick, draw=black!70},
                fare_arrow/.style={->, >={Stealth[length=3mm]}, very thick},
                label_text/.style={font=\footnotesize\bfseries}
            ]
            
            \node[station, label=below:島田] (Shimada) at (0,0) {};
            \node[station, label=below:焼津] (Yaidu) at (4,0) {};
            \node[station, label=below:静岡] (Shizuoka) at (8,0) {};
            
            \draw[path_line] (Shimada) -- (Yaidu) -- (Shizuoka);
            
            \draw[fare_arrow] (0,1) -- node[above, align=center] {510円（27.6km）} (8,1);
            \draw[fare_arrow] (0,-1.3) -- node[below, align=center] {240円（13.5km）} (3.9,-1.3);
            \draw[fare_arrow] (4.1,-1.3) -- node[below, align=center] {240円（14.1km）} (8,-1.3);
                
            \end{tikzpicture}
            \caption{キロ単価の非単調性による分割例}
            \label{fig:bunkatsu1}
        \end{figure}

    \item \textbf{特定区間運賃の利用:}\\
        競合他社線に対抗するために設定された「特定区間運賃」を適用させるために，当該区間を独立させて分割する．
        田端駅から成田駅までの経路と分割例を図\ref{fig:bunkatsu2}に示す．
        本州3社の幹線の60.1〜70.0kmの運賃は1,170円であるが，それに関わらず，日暮里駅と成田駅では競合私鉄の存在により940円の特定運賃が設定されている．
        よって，日暮里駅での分割により特定区間運賃を適用させることで，分割しない場合よりも80円安くなる．

        \begin{figure}[htbp]
            \centering
            \begin{tikzpicture}[
                station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white, font=\small},
                path_line/.style={-, ultra thick, draw=black!70},
                path_calc/.style={-, ultra thick, draw=black!70},
                path_ride/.style={-, ultra thick, draw=black!70},
                fare_arrow/.style={->, >={Stealth[length=3mm]}, very thick},
                label_text/.style={font=\footnotesize\bfseries}
            ]
            
            \node[station, label=below:田端] (Tabata) at (0,0) {};
            \node[station, label=below:日暮里] (Nippori) at (4,0) {};
            \node[station, label=below:成田] (Narita) at (12,0) {};
            
            \draw[path_line] (Tabata) -- (Nippori) -- (Narita);
            
            \draw[fare_arrow] (0,1) -- node[above, align=center] {1,170円（65.5km）} (12,1);
            \draw[fare_arrow] (0,-1.3) -- node[below, align=center] {150円（1.3km）} (3.9,-1.3);
            \draw[fare_arrow] (4.1,-1.3) -- node[below, align=center] {940円（64.2km）} (12,-1.3);
            
            \end{tikzpicture}
            \caption{特定区間運賃による分割例}
            \label{fig:bunkatsu2}
        \end{figure}

    \item \textbf{長距離区間における距離帯間隔の拡大:}\\
        営業キロに応じた運賃は，距離帯ごとに定められた間隔で段階的に上昇する．
        表\ref{tab:fare_interval}に示すように，10.1〜50.0kmの区間では運賃は5.0kmごとに，
        50.1〜100.0kmの区間では10.0kmごとに上昇する．
        さらに，営業キロが600.0kmを超えると，運賃は40.0kmごとに上昇するようになり，
        距離が長くなるにつれて運賃が変化する間隔は大きくなる．

        このように長距離区間では運賃帯の幅が広いため，
        短距離の乗車券を別途購入して営業キロを調整することで，
        本体となる乗車券の営業キロを一つ下の運賃帯に収め，
        結果として全体の運賃を低減できる場合がある．

        \begin{table}[H]
            \centering
            \caption{営業キロに対する運賃変化間隔}
            \label{tab:fare_interval}
            \begin{tabular}{c c}
                \hline
                営業キロの範囲 & 運賃が上昇する間隔 \\
                \hline
                10.0〜50.0km   & 5.0kmごと \\
                50.0〜100.0km & 10.0kmごと \\
                100.0〜600.0km & 20.0kmごと \\
                600.0km以上  & 40.0kmごと \\
                \hline
            \end{tabular}
        \end{table}

        山陽本線と東海道本線を利用する福山駅から静岡駅までの経路と分割例を図\ref{fig:bunkatsu3}に示す．
        この場合，分割したときの運賃は分割しない場合よりも90円安くなる．

        \begin{figure}[H]
            \centering
            \begin{tikzpicture}[
                station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white, font=\small},
                path_line/.style={-, ultra thick, draw=black!70},
                path_calc/.style={-, ultra thick, draw=black!70},
                path_ride/.style={-, ultra thick, draw=black!70},
                fare_arrow/.style={->, >={Stealth[length=3mm]}, very thick},
                label_text/.style={font=\footnotesize\bfseries}
            ]
            
            \node[station, label=below:福山] (Hukuyama) at (0,0) {};
            \node[station, label=below:焼津] (Yaidu) at (8,0) {};
            \node[station, label=below:静岡] (Shizuoka) at (12,0) {};
            
            \draw[path_line] (Hukuyama) -- (Yaidu) -- (Shizuoka);
            
            \draw[fare_arrow] (0,1) -- node[above, align=center] {9,790円（611.0km）} (12,1);
            \draw[fare_arrow] (0,-1.3) -- node[below, align=center] {9,460円（597.5km）} (7.9,-1.3);
            \draw[fare_arrow] (8.1,-1.3) -- node[below, align=center] {240円（13.5km）} (12,-1.3);
                
            \end{tikzpicture}
            \caption{長距離区間における距離帯間隔の拡大による分割例}
            \label{fig:bunkatsu3}
        \end{figure}

    \item \textbf{電車特定区間運賃の適用:}\\
        割安な「電車特定区間」と通常の「幹線」をまたがって乗車する場合，全区間が幹線の賃率で計算されてしまう．
        そこで電車特定区間内で分割することにより，電車特定区間部分に安い賃率を適用させる．
        関西本線の久宝寺駅から大河原駅までの経路と分割例を図\ref{fig:bunkatsu4}に示す．
        15.1〜20.0kmでの幹線の運賃は330円，電車特定区間の運賃は320円である．
        この場合，分割したときの運賃は分割しない場合よりも10円安くなる．

        \begin{figure}[H]
            \centering
            \begin{tikzpicture}[
                station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white, font=\small},
                path_line/.style={-, ultra thick, draw=black!70},
                path_calc/.style={-, ultra thick, draw=black!70},
                path_ride/.style={-, ultra thick, draw=black!70},
                fare_arrow/.style={->, >={Stealth[length=3mm]}, very thick},
                zone/.style={draw=gray, dashed, rounded corners, fill=gray!10},
                label_text/.style={font=\footnotesize\bfseries}
            ]

            \filldraw[zone] (-1,-1) rectangle (5,2.5);
            \node at (2, 2) {\bf 電車特定区間内};
            \node at (8, 1.3) {990円（55.5km）};

            \node[station, label=below:久宝寺] (Kyuhoji) at (0,0) {};
            \node[station, label=below:法隆寺] (Horyuji) at (4,0) {};
            \node[station, label=below:木津] (Kidu) at (8,0) {};
            \node[station, label=below:大河原] (Ohgawara) at (12,0) {};
            
            \draw[path_line] (Kyuhoji) -- (Horyuji) -- (Kidu) -- (Ohgawara);
            
            \draw[fare_arrow] (0,1) -- node[above, align=center] {} (12,1);
            \draw[fare_arrow] (0,-1.3) -- node[below, align=center] {320円（18.6km）} (3.9,-1.3);
            \draw[fare_arrow] (4.1,-1.3) -- node[below, align=center] {330円（18.8km）} (7.9,-1.3);
            \draw[fare_arrow] (8.1,-1.3) -- node[below, align=center] {330円（18.1km）} (12,-1.3);
                
            \end{tikzpicture}
            \caption{電車特定区間運賃の適用による分割例}
            \label{fig:bunkatsu4}
        \end{figure}

    \item \textbf{特定都区市内制度の適用または回避:}\\
        特定都区市内発着の特例制度を利用して運賃計算経路を短縮したり，特例が適用されることによる発着駅から中心駅までの運賃計算を避けるために分割すると合計運賃が安くなることがある．
        山陽本線で宮島口駅から網干駅までの経路と分割例を図\ref{fig:bunkatsu6}に示す．
        この例では，特定都区市内の境界駅である五日市駅において分割をすることで，特定都区市内発着の特例を適用させ，特定都区市の中心駅の広島駅から境界駅の五日市駅までを運賃計算経路から除外した．
        この場合，分割したときの運賃は分割しない場合よりも570円安くなる．

        \begin{figure}[H]
            \centering
            \begin{tikzpicture}[
                station/.style={circle, draw=black, thick, minimum size=6mm, inner sep=0pt, fill=white, font=\small},
                path_line/.style={-, ultra thick, draw=black!70},
                path_calc/.style={-, ultra thick, draw=black!70},
                path_ride/.style={-, ultra thick, draw=black!70},
                fare_arrow/.style={->, >={Stealth[length=3mm]}, very thick},
                zone/.style={draw=gray, dashed, rounded corners, fill=gray!10},
                label_text/.style={font=\footnotesize\bfseries}
            ]
            
            \filldraw[zone] (3,-1) rectangle (9,2.5);
            \node at (6, 2) {\bf 広島市内};
            \node at (6, 0.5) {\small 中心駅};
            \node at (6, 1.3) {4,840円（261.1km）};

            \node[station, label=below:宮島口] (Miyajimagichi) at (0,0) {};
            \node[station, label=below:五日市] (Itsukaichi) at (4,0) {};
            \node[station, label=below:広島] (Hiroshima) at (6,0) {};
            \node[station, label=below:網干] (Aboshi) at (12,0) {};
            
            \draw[path_line] (Miyajimagichi) -- (Itsukaichi) -- (Hiroshima) -- (Aboshi);
            
            \draw[fare_arrow] (0,1) -- node[above, align=center] {} (12,1);
            \draw[fare_arrow] (0,-1.3) -- node[below, align=center] {200円（9.7km）} (3.9,-1.3);
            \draw[fare_arrow] (6.1,-1.3) -- node[below, align=center] {4070円（239.6km）} (12,-1.3);
                
            \end{tikzpicture}
            \caption{分割をすることで，特定都区市内発着の特例を適用させた例}
            \label{fig:bunkatsu6}
        \end{figure}
\end{enumerate}

\section{問題定義}
本研究における問題定義は以下の通りである．
発駅と着駅のみを入力として，その間を最も安価に移動できる分割乗車券の経路と合計運賃を出力する．
このとき，乗車券の分割数には制限を設けず，最安分割乗車券の候補となる経路は全て探索する．

%%%%%%%%%%%%%%%%%%%%%
% 3章
%%%%%%%%%%%%%%%%%%%%%
\chapter{最安片道運賃計算アルゴリズム} \label{chapter:program}

\section{最安片道乗車券と最安片道運賃}
本研究における「最安片道乗車券」とは，入力された経路の全区間を包含し，かつ旅客営業規則に則って乗車することができる全ての片道乗車券の中で，その運賃が最も安価となるものを指す．
また，その運賃のことを「最安片道運賃」と定義する．
つまり，最安片道乗車券を用いれば，それ以上に乗車区間を延伸することによる運賃の減少という逆転現象は起こり得ない．
このような性質から，第\ref{chapter:algorithm}章のアルゴリズムでは，最安片道運賃のみを考慮することで，探索を効率よく行うことができる．

\section{片道運賃計算アルゴリズム}
運賃計算アルゴリズムでは，入力された経路に対して付録Aの規則による経路の補正を行い，以下のように規則に則った厳密な運賃を計算する．
\begin{itemize}
    \item
        並行する他社路線に対抗するために通常の距離制運賃よりも安く設定された区間である特定運賃区間と経路が一致する場合は，通常のキロ制運賃よりも優先してその特定運賃を参照する．
    \item
        入力された経路が，山手線内の駅相互発着の場合，東京附近における電車特定区間内の駅相互発着の場合，大阪附近における電車特定区間内の駅相互発着の場合はそれぞれに対応した賃率により運賃を計算する．
    \item
        全ての駅間を旅客会社ごとに分けて，まずはすべての区間を本州3社の運賃体系で計算をする．
        JR北海道，JR四国，JR九州のそれぞれの区間で，会社ごとの運賃から本州3社の運賃の差を加算額として加える．
        また，加算運賃区間にまたがる場合は加算運賃を加えた額を返す．
    \item
        上記3つを考慮して運賃計算をした上で，鉄道バリアフリー料金該当区間相互発着の場合は鉄道バリアフリー料金を運賃に加える．\\
\end{itemize}

\section{最安片道運賃計算アルゴリズム}
この最安運賃計算アルゴリズムでは，入力経路に対する最安片道乗車券の発着駅，経路，運賃が1つ出力される．
第\ref{subsection:69}項での経路特定区間に関する運賃の逆転現象においては，経路特定区間の○印でない経路上に発着駅があった場合に，その駅を外方の分岐駅まで伸ばした運賃と比較することにより逆転現象を考慮した最安運賃探索をしている．
第\ref{subsection:86}節での特定都区市内制度の制度設計に起因する運賃の逆転現象においては，まず以下の条件を満たすかを確かめる．

\begin{enumerate}
    \item 特定都区市の中心駅から特定都区市内でない方の発着駅までの営業キロが200.0km以下で，特定都区市内制度の適用外である．
    \item 運賃計算キロが200.0kmを超えている．
    \item 発着駅のいずれか一方が特定都区市内にある．
\end{enumerate}

これらを全て満たしているとき，特定都区市内でない方の発着駅を，特定都区市の中心駅からの営業キロが200.0kmを超えるまで1駅ずつ外方に伸ばしていき，運賃を比較することにより逆転現象を考慮した最安運賃探索をしている．

%%%%%%%%%%%%%%%%%%%%%
% 4章
%%%%%%%%%%%%%%%%%%%%%
\chapter{最安分割乗車券探索アルゴリズム} \label{chapter:algorithm}

本章では，前章で定義した最安片道運賃の計算アルゴリズムを基盤とし，任意の駅間における最安分割乗車券を導出するための探索アルゴリズムについて述べる．

\section{最安分割乗車券と最安分割運賃}
分割運賃が片道運賃よりも安くなりうるため，購入したほうが合計運賃が安価になる場合がある．
発駅と着駅が与えられたとき，発駅から着駅までの実乗車経路とその経路で乗車することのできる $2^n$ 通りの分割パターンの片道乗車券の集合を考える．
このうち，合計運賃が最安の片道乗車券の集合を「最安分割乗車券」と呼ぶ．
ある発着駅間を結ぶ特定の経路において，構成する各区間の運賃計算に必ず「最安片道運賃」を適用した上で，分割運賃が最小となる組み合わせを，当該経路における「最安分割乗車券」と定義する．
一般的な分割購入においては，個々の乗車券に外方への延伸等の最安片道運賃が適用されるとは限らないが，本研究のアルゴリズムにおいては，全ての分割区間において逆転現象を考慮した最安片道運賃を採用することで，真の最小コストを算出する．
ここで，運賃計算の特性上，分割駅の組み合わせが異なっても合計運賃が同額となる場合があるため，「最安分割乗車券」は一つの経路に対して複数存在し得る．
また，その際の最小となる運賃の総和を，当該経路の「最安分割運賃」と定義する．
最安分割乗車券の実乗車経路の候補は，単純パスだけを考えれば良い．
なぜならば，最安片道乗車券運賃の単調非減少性より，閉路を含む実乗車経路が最安だった場合でも，その閉路を除いた単純パスを実乗車経路を考えることで，同じ運賃で実乗車経路を単純パスとすることできるからである．

\section{探索アルゴリズム}
探索アルゴリズムの選定において，A*アルゴリズムなどのヒューリスティック探索を用いることで計算量を削減する手法が考えられる．
しかし，JRの運賃制度には営業キロが物理的な距離よりも短く設定されている区間が存在する．
このため，物理的な距離等をヒューリスティック関数 $h(n)$ として用いた場合，推定値が実際のコストを上回り過大評価するケースが発生し，A*アルゴリズムの許容条件 $h(n) \leqq h^*(n)$ を満たさなくなる．
これにより，最安解の見逃しが発生するリスクがある．
また，動的計画法を用いた手法についても検討したが，予備実験において探索空間の増大に伴いメモリ使用量が爆発的に増加し，計算継続が困難となった．
以上の理由により，本研究ではヒューリスティックを用いない Dijkstra's Algorithm\cite{dijkstra} および Yen's Algorithm\cite{yen} を採用し，解の正当性を保証する．

提案手法の手順は以下の通りである．

\begin{enumerate}
    \item \textbf{基準経路の探索:}\\
    Dijkstra's Algorithm\cite{dijkstra}を用い，発駅から着駅までの運賃計算キロが最短となる経路を探索する．
    これを探索の基準経路とし，その正確な運賃計算キロ（0.1km単位）を $d_{min}$，その運賃を $C_{base}$ とする．

    \item \textbf{候補経路の列挙:}\\
    Yen's Algorithm\cite{yen}を用い，第$K$最短経路を順次探索して候補経路リストに追加する．
    ここで，探索の打ち切り条件（距離の閾値 $d_{limit}$）を次のように定義する．
    本研究では，基準経路の距離 $d_{min}$ 以下の範囲で成立しうる最安キロ単価を用いる．
    
    距離 $x$ における運賃を $F(x)$ としたとき，任意の距離 $D$ 以下の範囲における最安キロ単価関数 $u_{best}(D)$ を以下のように定義する．
    \[u_{best}(D) = \min_{x \in S, x \leqq D} \left( \frac{F(x)}{x} \right)\]
    ここで，$S$ は運賃表において運賃が変化する距離の境界値（3.0, 6.0, 10.0, $\dots$）および $D$ 自身を含む集合である．また，$F(x)$ は消費税および端数処理を含んだ実際の運賃表の値とする．
    
    この $u_{best}(d_{min})$ を用いて，探索打ち切り距離 $d_{limit}$ を以下の式で定める．
    \[d_{limit} = \frac{C_{base}}{u_{best}(d_{min})} + \alpha\]
    
    ここで，$\alpha$ は特定都区市内制度や経路特定区間による距離の乖離を吸収するための補正項であり，以下の式で算出される．
    \[\alpha = (\delta_{start} + \delta_{end}) + (\rho_{start} + \rho_{end})\]
    ただし，各変数の定義は以下の通りとする．
    \begin{itemize}
        \item $\delta_{start}, \delta_{end}$: 発駅および着駅が特定都区市内に属する場合の「当該駅からその特定都区市内の中心駅までの運賃計算キロ」．属さない場合は0．
        \item $\rho_{start}, \rho_{end}$: 発駅が，旅客営業規則第69条における「○印の無い経路（迂回経路）」上にあり，その後「○印の経路」を乗り通す場合，「当該区間における迂回経路の運賃計算キロ」と「○印の経路の運賃計算キロ」の差分．それ以外の場合は 0．
    \end{itemize}
    探索経路の運賃計算キロが $d_{limit}$ を超えた時点で，それ以上の探索を打ち切る．

    \item \textbf{解の出力:}\\
    列挙された各候補経路について，全てパターンの分割運賃計算を行い最安分割運賃と経路を出力する．
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%
% 5章
%%%%%%%%%%%%%%%%%%%%%
\chapter{探索システムの設計と実装} \label{chapter:implementation}

\section{開発環境と使用技術}
\begin{itemize}
    \item TypeScript（Node.js）
\end{itemize}

\section{運賃・経路データの構築}
以下のデータをそれぞれプログラムへ読み込む．
なお，営業キロと賃率換算キロ及び擬制キロはJR時刻表\cite{jikoku}のデータを利用している．

\begin{itemize}
    \item 入力用データリスト
    \begin{itemize}
        \item 駅名かなデータ，路線駅データ，乗換データ
    \end{itemize}
    \item 特定市内データ
    \begin{itemize}
        \item 市名とそれに属する駅の集合
    \end{itemize}
    \item 経由印字データリスト
    \begin{itemize}
        \item 路線名に紐づく経由印字
    \end{itemize}
    \item 各駅間におけるセグメントデータリスト
    \begin{itemize}
        \item 営業キロ，換算キロ，旅客会社
    \end{itemize}
    \item 私鉄との競合区間における特定運賃リスト
    \item 旅客営業規則 第69条による経路の置き換えリスト
    \item 山手線内の駅リスト
\end{itemize}

\subsection{主要モジュールの実装}

\subsubsection{最安運賃計算プログラム}
最安分割乗車券プログラムから呼び出されるプログラムであり，発駅と着駅の他に経路も指定する必要がある．
入力として受け取った発駅から着駅までの経路を含む乗車券のうち最安のものを返す．
ここでは，分割することは考えずに最安片道乗車券として出力する．

\subsubsection{最安分割乗車券プログラム}
本節では，第\ref{chapter:algorithm}章で定義した探索アルゴリズムを，TypeScriptを用いて具体的なソフトウェアとして実装する際の詳細について述べる．
実装においては，計算速度とメモリ効率を重視し，以下のデータ構造および処理方式を採用した．

\begin{enumerate}
    \item \textbf{Priority Queueの実装:}\\
    基準経路探索およびYen's Algorithm\cite{yen}の内部処理で用いるDijkstra's Algorithm\cite{dijkstra} の実装においては，探索ノードの取り出しを高速化するためにBinary Heapを用いたPriority Queueを採用した．
    これにより，ノード数が膨大になる長距離区間の探索においても，計算量の増大を抑えている．

    \item \textbf{Yen's Algorithmにおける経路管理:}\\
    第$K$最短経路の探索において，候補となる経路群はメモリ上でリスト構造として管理される．
    第\ref{chapter:algorithm}章で定義した打ち切り閾値 $d_{limit}$ の判定は，経路が1本見つかるごとに動的に行われ，条件を満たさなくなった時点で直ちにループを脱出する設計とした．
    これにより，無駄な探索処理が走ることを防いでいる．
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%
% 第6章 評価および結論
%%%%%%%%%%%%%%%%%%%%%
\chapter{評価および結論} \label{chapter:evaluation_conclusion}

本章では，開発したシステムの有用性を検証するための評価実験の結果を述べ，それに基づく考察および本研究の結論をまとめる．

\section{実験概要}
本システムの有用性を検証するため，以下の3つの観点から評価実験を行う．
\begin{enumerate}
    \item \textbf{正当性:} 既存の乗車券分割プログラム\cite{oba}や券売機との一致確認．
    \item \textbf{有用性:} 分割による運賃削減効果の定量的評価．
    \item \textbf{性能:} 探索距離とトポロジーに応じた計算コストの分析とボトルネックの特定．
\end{enumerate}

評価に用いた計算機のスペック：MacBook Pro, Apple M4, 16GB.

\section{計算結果の正当性評価}
本システムの計算エンジンが，JRの複雑な運賃規則を正しく反映しているかを確認した．

\subsection{通常運賃の計算精度}
無作為に抽出した100区間において，公式の運賃検索サービスである「えきねっと」\cite{ekinet}と照合した結果，全区間で運賃が一致することを確認した．
特に，第\ref{chapter:fare_system}章で述べた「経路特定区間」や「特定都区市内」における外方延伸の逆転現象についても，本システムが自動的に最安経路を選択することを確認した．

\subsection{既存の乗車券分割プログラムとの比較}
既存の乗車券分割プログラム\cite{oba}を基準とし，同一経路における分割結果を比較した．
表\ref{tab:comparison_oba}に，東京→仙台における比較結果を示す．

\begin{table}[htbp]
    \centering
    \caption{既存の乗車券分割プログラムとの最安値比較（東京→仙台）}
    \label{tab:comparison_oba}
    \begin{tabular}{lrrcc} \toprule
        システム名 & 出力運賃 & 乗車経路 & 経路 \\ \midrule
        oba氏のプログラム & 5,830円 & 最短経路 & 指定 \\
        \textbf{本システム} & \textbf{5,800円} & \textbf{迂回経路} & \textbf{自動探索}  \\ \bottomrule
    \end{tabular}
\end{table}

既存サービスでは利用者が経路を指定する必要があるが，本システムは東北本線中の赤羽ー大宮間において埼京線を利用する迂回経路を自動的に発見し，さらなる安値を導出した．

\section{有用性評価：運賃削減効果}
第\ref{chapter:fare_system}章で分類した5つの分割要因に基づき，本システムによる削減効果を測定した（表\ref{tab:effectiveness}）．

\begin{table}[htbp]
    \centering
    \caption{各ケースにおける運賃削減効果の測定結果}
    \label{tab:effectiveness}
    \begin{tabular}{llrrr} \toprule
        要因 & 区間例 & 通常運賃 & \textbf{分割運賃} & 削減額 \\ \midrule
        特定運賃の利用 & 田端→成田 & 1,170円 & 1,090円 & 80円 \\
        長距離逓減の利用 & 福山→静岡 & 9,790円 & 9,700円 & 90円 \\
        都区市内の回避 & 宮島口→網干 & 5,170円 & 4,600円 & 570円 \\
        電車特定区間 & 久宝寺→大河原 & 990円 & 980円 & 10円 \\ \bottomrule
    \end{tabular}
\end{table}

さらに，東京駅を発駅とした東北本線の主な駅の距離別の削減効果を検証した結果を表\ref{tab:fare_reduction}に示す．

\begin{table}[htbp]
    \centering
    \caption{東京駅発における主な駅の距離ごとの最安分割運賃と削減効果}
    \label{tab:fare_reduction}
    \begin{tabular}{lrrrr} \toprule
        着駅 & 営業キロ & 通常運賃 & 最安分割運賃 & 削減額 \\ \midrule
        大宮 & 30.3 km & 580円 & 550円 & 30円 \\
        東鷲宮 & 51.6 km & 990円 & 880円 & 110円 \\
        小山 & 80.6 km & 1,520円 & 1,360円 & 160円 \\
        宇都宮 & 109.5 km & 1,980円 & 1,840円 & 140円 \\
        黒磯 & 163.3 km & 3,080円 & 2,680円 & 400円 \\
        白河 & 188.2 km & 3,410円 & 3,100円 & 310円 \\
        福島 & 272.8 km & 4,840円 & 4,510円 & 370円 \\
        名取 & 341.4 km & 6,050円 & 5,650円 & 400円 \\
        仙台 & 351.8 km & 6,050円 & 5,800円 & 250円 \\ \bottomrule
    \end{tabular}
\end{table}

表\ref{tab:fare_reduction}より，探索距離が伸びるにつれて削減額が増加する傾向にあることが確認できた．
さらに，この傾向を視覚的に捉えるため，東京駅を発駅とした全データにおける営業キロと運賃の関係を図\ref{fig:fare_comparison}に示す．

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.9\linewidth]{Graph_0.png}
    \caption{探索距離に伴う通常運賃と最安分割運賃の推移と削減効果}
    \label{fig:fare_comparison}
\end{figure}

図\ref{fig:fare_comparison}において，青い実線は通常運賃，赤い実線は本システムが導出した最安分割運賃を示している．
営業キロが100kmを超えたあたりから両者の乖離が顕著になり始めている．

\section{性能評価：計算コストの分析}
最短運賃計算キロ $d$ の増加に伴う計算時間の推移を測定した．東京駅を発駅とし，東北本線沿線の主要駅への探索を行った結果を表\ref{tab:performance}に示す．

\begin{table}[htbp]
    \centering
    \caption{探索距離に伴う経路候補数と計算時間の推移}
    \label{tab:performance}
    \begin{tabular}{lrrr} \toprule
        着駅 & 営業キロ ($d$) & 経路候補数 & 計算時間 \\ \midrule
        大宮 & 30.3 km & 43 & 0.34秒 \\
        東鷲宮 & 51.6 km & 78 & 1.37秒 \\
        小山 & 80.6 km & 123 & 4.08秒 \\
        宇都宮 & 109.5 km & 127 & 5.73秒 \\
        黒磯 & 163.3 km & 360 & 31.36秒 \\
        白河 & 188.2 km & 360 & 39.21秒 \\
        福島 & 272.8 km & 360 & 329.53秒 \\
        名取 & 341.4 km & 2,977 & 1833.13秒 \\
        仙台 & 351.8 km & 2,020 & 1232.82秒 \\ \bottomrule
    \end{tabular}
\end{table}

表\ref{tab:performance}の傾向をより詳細に分析するため，全テストケースにおける探索距離，経路候補数，および計算時間の関係を図\ref{fig:performance_analysis}に示す．

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.9\linewidth]{Graph_1.png}
    \caption{探索距離に伴う経路候補数と計算時間の推移}
    \label{fig:performance_analysis}
\end{figure}

図\ref{fig:performance_analysis}において，横軸は東京駅からの営業キロを示し，縦軸には列挙された経路候補数（赤い実線）と，その計算に要した時間（青い実線）をプロットしている．
図より，経路候補数と計算時間が極めて強い正の相関関係にあることが視覚的に確認できる．特に営業キロが200kmを超える地点で両者が急激に跳ね上がっており，特定のトポロジー（複雑な分岐網を持つ大都市圏）が計算量に与える影響の大きさが裏付けられた．

\section{考察}
実験の結果，本システムは全国規模の路線網において，利用者が経路を一切指定することなく，厳密な最安分割運賃を導出可能であることが証明された．
これは，従来のヒューリスティック探索では見逃されがちであった迂回経路を包括的に探索できる本アルゴリズムの優位性を示している．

一方で，表\ref{tab:performance}に示す通り，探索距離の増加に伴い計算コストが指数関数的に増大する課題が浮き彫りとなった．
特に，東京駅からの営業キロが341.4kmに位置する名取駅においては，経路候補数が2,977件に達し，計算時間が約30分（1,833.13秒）を要した．
これは，大宮駅や小山駅など，複数の路線が乗り入れるターミナル駅を通過する際，分岐数が増加し，Yen's Algorithmの探索空間が爆発的に拡大したためであると考えられる．

現状のアルゴリズムではWebサービス水準の数秒以内という即応性の確保が困難であるため，今後は特定のトポロジーを事前検知し，運賃逆転が起こり得ない遠回り経路を早期に除外するための，より厳格な枝刈り条件の導入が不可欠である．

\section{結論}
\subsection{本研究の総括}
本研究では，JR分割乗車券の最適解を探索するプログラムをDijkstra's Algorithm\cite{dijkstra}およびYen's Algorithm\cite{yen}を用いて開発した．
本システムにより，従来困難であった経路指定不要の広域探索が可能となり，複雑な運賃制度を厳密に考慮した上での最安解導出を実現した．評価実験により，既存手法を上回る運賃削減効果が実証された．

\subsection{将来の展望と今後の課題}
今後の展望としては，新幹線や特急料金を含めたトータルコストの最適化や，Webサービスとしての一般公開，モバイルアプリ化などが挙げられる．
一方で課題としては，運賃改定時のシステム再構築の容易化や，さらなる計算速度の向上，学割などの各種割引制度への対応が残されている．

%%%%%%%%%%%%%%%%%%%%%
% 謝辞
%%%%%%%%%%%%%%%%%%%%%
\syaji
\par
本論文について貴重な御助言を頂いた指導教員や研究室のメンバー方には心より感謝致します．

%%%%%%%%%%%%%%%%%%%%%
% 参考文献
%%%%%%%%%%%%%%%%%%%%%
\begin{thebibliography}{99}
\addcontentsline{toc}{chapter}{参考文献}

\bibitem{dijkstra}
E.W. Dijkstra, A note on two problems in connexion with graphs, \textit{Numerische Mathematik}, vol.~1, pp.~269--271, 1959.

\bibitem{hirata}
平田 直也, 中桐 斉之, スマートフォンに特化した乗車券分割アプリの開発, 第78回全国大会講演論文集, vol.~2016, no.~1, pp.~387--388, 2016.

\bibitem{jikoku}
時刻表編集部，ＪＲ時刻表 2025年10月号，交通新聞社，2025．

\bibitem{ekinet}
JR東日本，えきねっと，入手先〈\url{https://www.eki-net.com/personal/top/index}〉（参照2025-12-25）．

\bibitem{ryokaku}
JR東日本，旅客営業規則，入手先〈\url{https://www.jreast.co.jp/ryokaku/}〉（参照2025-12-25）．

\bibitem{trrc}
川浦 龍一，遠い方が安くなる？！　なぜなにJR旅客営業制度 --きっぷのふしぎ--，交通法規研究会，東京，2024．

\bibitem{oba}
oba，乗車券分割プログラム，入手先〈\url{https://bunkatsu.jp/}〉（参照2025-12-25）．

\bibitem{yen}
Jin Y. Yen, Finding the K Shortest Loopless Paths in a Network, \textit{Management Science}, vol.~17, no.~11, pp.~712--716, 1971.

\end{thebibliography}

%%%%%%%%%%%%%%%%%%%%%
% 付録
%%%%%%%%%%%%%%%%%%%%%
\appendix
\def\labelenumi{(\theenumi)}
\chapter{運賃計算における経路補正}

片道乗車券の運賃計算する際の経路補正に関する規則のみを抜粋して掲載する．規則の全文については参考文献\cite{ryokaku}を参照されたい．
\\\\
\noindent\textbf{（旅客運賃・料金計算上の経路等）}\\
\noindent\textbf{第67条}\\
旅客運賃・料金は、旅客の実際乗車する経路及び発着の順序によって計算する。\\

\noindent\textbf{（特定区間における旅客運賃・料金計算の営業キロ又は運賃計算キロ）}\\
\noindent\textbf{第69条}\\
第67条の規定にかかわらず、次の各号に掲げる区間の普通旅客運賃・料金は、その旅客運賃・料金計算経路が当該各号末尾のかっこ内の両線路にまたがる場合を除いて、○印の経路の営業キロ（第9号については運賃計算キロ。ただし、岩国・櫛ヶ浜間相互発着の場合にあっては営業キロ）によって計算する。この場合、各号の区間内については、経路の指定を行わない。

\begin{enumerate}
    \item 大沼以遠（仁山方面）の各駅と、森以遠（石倉方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　東森駅経由函館本線\\
                    ○大沼公園駅経由函館本線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 日暮里以遠（鶯谷又は三河島方面）の各駅と、赤羽以遠（川口、北赤羽又は十条方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　尾久経由東北本線\\
                    ○王子経由東北本線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 赤羽以遠（尾久、東十条又は十条方面）の各駅と、大宮以遠（土呂、宮原又は日進方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　戸田公園・与野本町経由東北本線\\
                    ○川口・浦和経由東北本線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 品川以遠（高輪ゲートウェイ又は大崎方面）の各駅と、鶴見以遠（新子安、国道又は羽沢横浜国大方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　西大井経由東海道本線\\
                    ○大井町経由東海道本線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 東京以遠（有楽町又は神田方面）の各駅と、蘇我以遠（鎌取又は浜野方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　京葉線\\
                    ○総武本線・外房線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 山科以遠（京都方面）の各駅と、近江塩津以遠（新疋田方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　東海道本線・北陸本線\\
                    ○湖西線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 大阪以遠（塚本又は新大阪方面）の各駅と、天王寺以遠（東部市場前又は美章園方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　福島経由大阪環状線\\
                    ○天満経由大阪環状線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 三原以遠（糸崎方面）の各駅と、海田市以遠（向洋方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　呉線\\
                    ○山陽本線
                \end{tabular}
            \Bigg)
        $
    \\
    \item 岩国以遠（和木方面）の各駅と、櫛ヶ浜以遠（徳山方面）の各駅との相互間\\
        \qquad    
        $
            \Bigg(
                \begin{tabular}{l}
                    　山陽本線\\
                    ○岩徳線
                \end{tabular}
            \Bigg)
        $

\end{enumerate}

\noindent\textbf{第70条}\\
第67条の規定にかかわらず、旅客が次に掲げる図の太線区間を通過する場合の普通旅客運賃・料金は太線区間内の最も短い営業キロによって計算する。この場合、太線内は、経路の指定を行わない。\\
\newline
\includegraphics[scale=0.9]{70.png}
\newline

\noindent\textbf{2}\\
蘇我以遠（鎌取又は浜野方面）の各駅と前条第1項第5号に掲げるいずれかの経路を経由して前項に掲げる図の太線区間を大久保以遠（東中野方面）、三河島以遠（南千住方面）、川口以遠（西川口方面）又は北赤羽以遠（浮間舟渡方面）へ通過する場合の普通旅客運賃・料金は、第67条及び前条第1項第5号の規定にかかわらず、外房線蘇我・千葉間、総武本線千葉・錦糸町間及び前項に掲げる図の太線区間内の最も短い経路の営業キロによって計算する。\\

\noindent\textbf{（特定都区市内にある駅に関連する片道普通旅客運賃の計算方）}\\
\noindent\textbf{第86条}\\
次の各号の図に掲げる東京都区内、横浜市内（川崎駅、尻手駅、八丁畷駅、川崎新町駅及び小田栄駅並びに鶴見線各駅を含む。）、名古屋市内、京都市内、大阪市内（南吹田駅、高井田中央駅、JR河内永和駅、JR俊徳道駅、JR長瀬駅及び衣摺加美北駅を含む。）、神戸市内（道場駅を除く。）、広島市内（海田市駅及び向洋駅を含む。）、北九州市内、福岡市内（姪浜駅、下山門駅、今宿駅、九大学研都市駅及び周船寺駅を除く。）、仙台市内又は札幌市内（以下これらを「特定都区市内」という。）にある駅と、当該各号に掲げる当該特定都区市内の◎印の駅（以下「中心駅」という。）から片道の営業キロが200キロメートルを超える区間内にある駅との相互間の片道普通旅客運賃は、当該中心駅を起点又は終点とした営業キロ又は運賃計算キロによって計算する。\\
ただし、特定都区市内にある駅を発駅とする場合で、普通旅客運賃の計算経路が、その特定都区市内の外を経て、再び同じ特定都区市内を通過するとき、又は特定都区市内にある駅を着駅とする場合で、発駅からの普通旅客運賃の計算経路が、その特定都区市内を通過して、その特定都区市内の外を経るときを除く。\\[5pt]
\quad(1)〜(10) 略\\

\noindent\textbf{（東京山手線内にある駅に関連する片道普通旅客運賃の計算方）}\\
\noindent\textbf{第87条}\\
東京山手線内にある駅と、中心駅から片道の営業キロが100キロメートルを超え200キロメートル以下の区間内にある駅との相互間の片道普通旅客運賃は、当該中心駅を起点又は終点とした営業キロ又は運賃計算キロによって計算する。\\
ただし、東京山手線内にある駅を発駅とする場合で、普通旅客運賃の計算経路が、東京山手線内の外を経て、再び東京山手線内を通過するとき、又は東京山手線内にある駅を着駅とする場合で、発駅からの普通旅客運賃の計算経路が、東京山手線内を通過して、東京山手線内の外を経るときを除く。\\

\noindent\textbf{（新大阪駅又は大阪駅発又は着となる片道普通旅客運賃の計算方）}\\
\noindent\textbf{第88条}\\
新大阪駅又は大阪駅と姫路駅以遠（英賀保、京口又は播磨高岡方面）の各駅との相互間の片道普通旅客運賃は、姫路駅を経由する場合に限り、大阪駅を起点又は終点とした営業キロ又は運賃計算キロによって計算する。\\

\noindent\textbf{（北新地駅発又は着となる片道普通旅客運賃の計算方）}\\
\noindent\textbf{第89条}\\
北新地駅と尼崎以遠（立花又は塚口方面）の各駅との相互間の片道普通旅客運賃は、加島駅を経由する場合に限り、大阪駅を起点又は終点とした営業キロ又は運賃計算キロ（いずれも塚本駅を経由するものとする。）によって計算する。ただし、第86条の規定により片道普通旅客運賃を計算する場合を除く。\\

\end{document}